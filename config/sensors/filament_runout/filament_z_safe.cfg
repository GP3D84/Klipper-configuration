[gcode_macro FILAMENT_Z_SAFE]
gcode:
		{% set variables = printer['gcode_macro _SENSOR_VARIABLES'] %}  
        {% set z = params.Z|default(variables.attempts_park_lift_z)|float %}    # Ex: z= variable_z_lift = -1
        {% set max_z = printer.toolhead.axis_maximum.z|float %}            # Ex: axis_maximum.z = 300
        {% set act_z = printer.toolhead.position.z|float %}                # Ex: act_z = 299.5
        {% set lift_z = z|abs %%}                                            # Ex: lift_z = 1
        {% if act_z < (max_z - lift_z) %}                  # Ex: if 299.5 < 300-1  -> z-safe = 0.5
            {% set z_safe = lift_z %}                      # Ex: set z_safe = 1
        {% else %}
            {% set z_safe = max_z - act_z %}               # Ex: z_safe = 300 - 299.5 = 0.5
        {% endif %}        
        G91
        G1 Z{z_safe}
	G90
